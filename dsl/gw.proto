syntax = "proto3";

package gw;

option go_package = "./gw";
option java_multiple_files = true;
option java_package = "gen.gw";

enum Result {
    // 失败
    Fail = 0;
    // ID不存在
    IdNone = 1;
    // 分布冲突
    ProdErr = 2;
    // 成功
    Succ = 16;
}

message CidReq {
    int64 cid = 1;
}

message GidReq {
    string gid = 1;
}

message Id64Rep {
    int64 id = 1;
}

message Id32Rep {
    int32 id = 1;
}

message DataRep {
    bytes data = 1;
}

message LoginReq {
    // 客户端唯一编号
    int64 cid = 1;
    // 登录数据
    bytes data = 2;
    // 客户端地址
    string addr = 3;
}

message LoginRep {
    // 数字编号
    int64 uid = 1;
    // 字符编号
    string sid = 2;
    // 唯一标识(一个标识，只允许一个Conn)
    string unique = 3;
    // 最大请求数
    int32 limit = 4;
    // 路由服务编号
    int32 rid = 5;
    // 路由服务映射
    map<string, int32> rids = 6;
    // 登录返回
    bytes data = 7;
    // 清理队列
    bool clear = 8;
    // 登录回调
    bool back = 9;
    // 登录失败
    bytes kickData = 10;
}

message LoginBack {
    int64 cid = 1;
    int64 uid = 2;
    string sid = 3;
}

message Member {
    // 用户编号
    string gid = 1;
    // 写扩散时，不推送，需要点击查看
    bool nofeed = 2;
}

message TeamRep {
    // 版本
    int64 version = 1;
    // 用户列表
    repeated Member members = 2;
    // 读扩散、写扩散
    bool readFeed = 3;
}

service Acl {
    // 登录
    rpc login(LoginReq) returns (LoginRep);
    // 登录回调
    rpc loginBack(LoginBack) returns (Id32Rep);
    // 组查询 tid
    rpc team(GidReq) returns (TeamRep);
}

message PassReq {
    int64 cid = 1;
    int64 uid = 2;
    string sid = 3;
    string uri = 4;
    bytes data = 5;
}

service Pass {
    // 请求
    rpc req(PassReq) returns (DataRep);
    // 发送
    rpc send(PassReq) returns (Id32Rep);
}

message CloseReq {
    int64 cid = 1;
    string reason = 2;
}

message KickReq {
    int64 cid = 1;
    bytes data = 2;
}

message RidReq {
    int64 cid = 1;
    string name = 2;
    int32 rid = 3;
}

message RidsReq {
    int64 cid = 1;
    map<string, int32> rids = 2;
}

message PushReq {
    int64 cid = 1;
    string uri = 2;
    bytes data = 3;
    bool isolate = 4;
    int64 id = 5;
}

message GPushReq {
    string gid = 1;
    string uri = 2;
    bytes data = 3;
    int32 qs = 4;
    string unique = 5;
    bool queue = 6;
    int64 fid = 7;
    bool isolate = 8;
}

message GConnReq {
    int64 cid = 1;
    string gid = 2;
    string unique = 3;
    bool kick = 4;
    // 新版本
    bool newVer = 5;
}

message GDiscReq {
    int64 cid = 1;
    string gid = 2;
    string unique = 3;
    int32 connVer = 4;
    bool kick = 5;
}

message GLastsReq {
    string gid = 1;
    int64 cid = 2;
    string unique = 3;
    int64 lastId = 4;
    int32 continuous = 5;
}

message SendReq {
    string fromId = 1;
    string toId = 2;
    string uri = 3;
    bytes data = 4;
    bool db = 5;
}

message TPushReq {
    string fromId = 1;
    string tid = 2;
    // 读扩散
    bool readFeed = 3;
    string uri = 4;
    bytes data = 5;
    bool db = 6;
    bool queue = 7;
}

// 网关
service Gateway {
    // 关闭连接
    rpc close(CloseReq) returns (Id32Rep);
    // 软关闭连接
    rpc kick(KickReq) returns (Id32Rep);
    // 服务编号
    rpc rid(RidReq) returns (Id32Rep);
    // 服务编号
    rpc rids(RidsReq) returns (Id32Rep);
    // 简单推送
    rpc push(PushReq) returns (Id32Rep);
    // 注册监听gid
    rpc gConn(GConnReq) returns (Id32Rep);
    // 断开监听gid
    rpc gDisc(GDiscReq) returns (Id32Rep);
    // 组通知 gid
    rpc gLast(GidReq) returns (Id32Rep);
    // 组推送 // uri 主题 // binary 消息体 // qs 消息质量，0 内存发送成功 1 队列发送[unique 唯一标识(消息队列，一个标识只需要最新数据)] 2 last队列 3 last 队列持久化
    rpc gPush(GPushReq) returns (Id64Rep);
    // 获取组更新消息
    rpc gLasts(GLastsReq) returns (Id32Rep);
    // 点对点聊天
    rpc send(SendReq) returns (Id32Rep);
    // readfeed读扩散，常用于聊天室
    rpc tPush(TPushReq) returns (Id32Rep);
    // 组更新、删除 tid
    rpc tDirty(GidReq) returns (Id32Rep);
}